var warnHandler=setTimeout(function(){$("#wrapper").html("<h2>It doesn't look like the socket2m server is running at the moment. Please come back later.</h2>")},1500),socket=typeof io!="undefined"?io.connect(null,{port:7979}):{on:function(){}},currentState=null,stateListeners={},pageTitle=$("title").html();typeof io=="undefined"&&(clearTimeout(warnHandler),$("#wrapper").html("<h2>The socket2m server is not running at the moment. Please come back later.</h2>")),socket.on("connect",function(){console.log("connected"),clearTimeout(warnHandler)}),socket.on("statechange",function(a){var b=(new Date).getTime(),c=!1,d=null,e=function(e,f){e!=null&&(console.log("fade out complete"),c=e),f!=null&&(console.log("data complete"),d=f);if(c&&d){console.log("fade & data complete"),$("#wrapper").html(d);var g=$("#wrapper h1:first");$("#state-wrapper").hide().children("#state-title").html(g.html()),$("title").html(pageTitle+" - "+g.html()),g.parent("div.page-header").remove(),g.remove(),$("#state-wrapper").fadeIn("fast"),$("#wrapper").fadeIn("fast"),loadScript("/states/js/"+a+".js?t="+b),currentState=a;for(var h in stateListeners)console.log("binding "+h+" listener"),socket.on(h,stateListeners[h]);console.log("changed state to "+a)}};$("#state-wrapper").fadeOut("fast"),$("#wrapper").fadeOut("fast",function(){e(!0,null)});for(var f in stateListeners)console.log("removing "+f+" listener"),socket.removeListener(f,stateListeners[f]);$.get("/states/"+a+".html?t="+b,{},function(a){e(null,a)})}),socket.on("msg",function(a){mbalert(a)}),loadScript("/shared/js/utils.js");Bullet=function(){this._x=0,this._y=0,this._a=0,this._v=0,this._alive=!1,this._owner=0,this._vx=0,this._vy=0,this._w=0,this._id=0},Bullet.prototype={spawn:function(a){this._x=a.x,this._y=a.y,this._a=a.a,this._v=a.v,this._owner=a.o,this._id=a.id,this._alive=!0,this._w=3,this._vx=Math.cos(this._a/180*Math.PI)*this._v,this._vy=Math.sin(this._a/180*Math.PI)*this._v},getOwner:function(){return this._owner},getId:function(){return this._id},tick:function(a){this._x+=this._vx*a,this._y+=this._vy*a,this._vy+=20*a;if(this._x<GameManager.getLeft()||this._x>GameManager.getRight()||this._y<GameManager.getTop()||this._y>GameManager.getBottom())this._alive=!1},isDead:function(){return!this._alive},preRender:function(){var a=GameManager.getSurface();a.clearRect(this._x|0,this._y|0,this._w,this._w)},render:function(){var a=GameManager.getSurface();a.square(this._x|0,this._y|0,this._w,"rgb(255, 0, 0)")},kill:function(){this._alive=!1},getLeft:function(){return this._x},getTop:function(){return this._y},getRight:function(){return this.getLeft()+this._w},getBottom:function(){return this.getTop()+this._w}},Bullet.factory=function(){return new Bullet};Platform=function(){this.x=0,this.y=0,this.w=0,this.h=0},Platform.prototype={setCoordinates:function(a,b,c,d){this.x=a,this.y=b,this.w=c,this.h=d},render:function(){GameManager.getSurface().fillRect(this.x,this.y,this.w,this.h,"rgb(0, 0, 0)")},getLeft:function(){return this.x},getTop:function(){return this.y},getRight:function(){return this.getLeft()+this.w},getBottom:function(){return this.getTop()+this.h}};Powerup=function(){this.x=0,this.y=0,this.r=0,this.type=0,this.alive=!1,this.id=0,this.letter=""},Powerup.prototype={spawn:function(a){this.x=a.x,this.y=a.y,this.r=a.r,this.type=a.type,this.id=a.id,this.alive=!0,this.letter=a.letter},preRender:function(){GameManager.getSurface().clearRect(this.x,this.y,this.r*2,this.r*2)},render:function(){GameManager.getSurface().circle(this.x,this.y,this.r,"rgb(0, 255, 128)"),GameManager.getSurface().fillText(this.x+this.r,this.y+1,this.letter,"rgb(100, 100, 100)",{font:"bold 13px sans-serif",textBaseline:"hanging",textAlign:"center"})},getLeft:function(){return this.x},getTop:function(){return this.y},getRight:function(){return this.getLeft()+this.r*2},getBottom:function(){return this.getTop()+this.r*2},getId:function(){return this.id},kill:function(){this.alive=!1},isDead:function(){return!this.alive}},Powerup.factory=function(){return new Powerup};var SoundManager=function(){var a={},b={},c={},d=!1;return a.toggleSounds=function(){d=!d},a.mute=function(){d=!0},a.unmute=function(){d=!1},a.preloadSound=function(a,d){if(b[a]==null){var e=document.createElement("audio");e.src=a,e.preload="auto",b[a]=e,$("body").append(e)}else console.log("not preloading sound - already loaded ["+a+"]");d!=null&&(c[d]=a)},a.playSound=function(e){if(d)return;b[e]==null&&(c[e]!=null?e=c[e]:(console.log("warning - "+e+" was not preloaded"),a.preloadSound(e))),b[e].play()},a}();function tick(){animFrame=requestAnimFrame(tick),GameManager.loop()}var GameManager=function(){var a={},b=0,c=0,d=0,e=null,f=null,g=null,h=[],i=[],j=[],k=[],l=[],m=[],n=0,o=-1,p=!1,q=!1,r=!1,s=!1,t=!1;return a.loop=function(){if(q)return;var b=(new Date).getTime();d=(b-c)/1e3;if(b%20==0){var e=Math.round(10/d)/10;$("#debug #fps").html(e+" fps")}c=b,r||(n>=0?(n-=d,Math.ceil(n)!=o&&(o=Math.ceil(n),$("#countdown").html(Utils.formatTime(o)))):p||(p=!0,socket.emit("game:timeup"))),a.preRender(),a.handleInput(),a.tick(),a.render()},a.preRender=function(){f.preRender(),g.preRender();for(var a=0,b=k.length;a<b;a++)k[a].preRender();for(var a=0,b=l.length;a<b;a++)l[a].preRender()},a.handleInput=function(){if(t)return;Input.isKeyDown("SPACE_BAR")&&f.fireWeapon(),Input.isKeyDown("LEFT_ARROW")?f.decreaseAngle():Input.isKeyDown("RIGHT_ARROW")&&f.increaseAngle(),Input.isKeyDown("DOWN_ARROW")?f.decreaseVelocity():Input.isKeyDown("UP_ARROW")&&f.increaseVelocity()},a.tick=function(){Math.floor(Math.random()*2501)==0&&l.length<3&&a.spawnPowerup();for(var b=0,c=h.length;b<c;b++){var e=h[b],n=e.socket_id==f.getId()?f:g;n.spawn({x:e.x,y:a.getCoordinateForPlatform(e.platform)}),n.getId()==g.getId()&&(s=!1)}h=[];for(var b=0,c=i.length;b<c;b++)for(var o=k.length-1;o>=0;o--)if(k[o].getId()==i[b]){console.log("killing entity "+k[o].getId()),k[o].kill(),k.splice(o,1);break}i=[];for(var b=0,c=j.length;b<c;b++)for(var o=l.length-1;o>=0;o--)if(l[o].getId()==j[b]){console.log("killing powerup "+l[o].getId()),l[o].kill(),l.splice(o,1);break}j=[];for(var b=k.length-1;b>=0;b--){k[b].tick(d);if(!k[b].isDead()){k[b].getOwner()==f.getId()&&a.entitiesTouching(k[b],g)&&s==0?(s=!0,k[b].kill(),a.killPlayer(g.getId(),k[b].getId())):k[b].getOwner()==g.getId()&&a.entitiesTouching(k[b],f)&&k[b].kill();if(!k[b].isDead())for(var c=l.length-1;c>=0;c--)k[b].getOwner()==f.getId()&&a.entitiesTouching(k[b],l[c])?(k[b].kill(),a.claimPowerup(l[c].getId(),k[b].getId())):k[b].getOwner()==g.getId()&&a.entitiesTouching(k[b],l[c])&&k[b].kill(),!l[c].isDead();if(!k[b].isDead()){var c=4;while(c--)if(a.entitiesTouching(k[b],m[c])){k[b].kill();break}}}k[b].isDead()&&(console.log("found dead entity ID "+k[b].getId()),k.splice(b,1))}},a.render=function(){f.render(),f.renderSight(),g.render();for(var a=0,b=m.length;a<b;a++)m[a].render();for(var a=0,b=k.length;a<b;a++)k[a].render();for(var a=0,b=l.length;a<b;a++)l[a].render()},a.initSurface=function(b){a.setSurface(new Surface(b))},a.setSurface=function(a){e=a},a.setPlayer=function(a){f=a},a.setOpponent=function(a){g=a},a.spawnPowerup=function(){socket.emit("game:powerup:spawn")},a.actuallySpawnPowerup=function(a){console.log("spawning powerup",a);var b=Powerup.factory();b.spawn(a),l.push(b),SoundManager.playSound("game:powerup:spawn")},a.fireWeapon=function(a){socket.emit("game:weapon:fire",a)},a.actuallyFireWeapon=function(b){var c=b.x,d=b.o,e=a.getCoordinateForPlatform(b.platform);b.o==f.getId()&&f.setReloadTime(b.reloadIn);for(var g=0,h=b.bullets.length;g<h;g++){var i=Bullet.factory(),j=b.bullets[g];j.o=d,j.x=c,j.y=e,i.spawn(j),k.push(i)}SoundManager.playSound("weapon:fire")},a.getSurface=function(){return e},a.getLeft=function(){return 0},a.getTop=function(){return 0},a.getBottom=function(){return a.getTop()+e.getHeight()},a.getRight=function(){return a.getLeft()+e.getWidth()},a.entitiesTouching=function(a,b){return a.getLeft()<=b.getRight()&&b.getLeft()<=a.getRight()&&a.getTop()<=b.getBottom()&&b.getTop()<=a.getBottom()},a.claimPowerup=function(a,b){console.log("requesting claim powerup "+a+" from bullet "+b),socket.emit("game:powerup:claim",{id:a,eId:b})},a.actuallyClaimPowerup=function(a){console.log("killing bullet "+a.eId+" and queueing powerup removal "+a.id),j.push(a.id),i.push(a.eId)},a.killPlayer=function(a,b){console.log("requesting kill player "+a+" from bullet "+b),socket.emit("game:player:kill",{id:a,eId:b})},a.actuallyKillPlayer=function(a){var b=a.id;console.log("actually killing player "+b),$("#game #p1").html(a.scores[0]),$("#game #p2").html(a.scores[1]),b==f.getId()?(a.doRespawn&&(SoundManager.playSound("player:die"),socket.emit("game:player:respawn")),console.log("queuing entity death "+a.eId),i.push(a.eId)):b==g.getId()?a.doRespawn&&SoundManager.playSound("player:kill"):console.log("unknown ID "+b)},a.actuallyRespawnPlayer=function(a){console.log("queuing respawning player",a.player),h.push(a.player),a.teleport&&SoundManager.playSound("player:teleport")},a.getCoordinateForPlatform=function(a){return(a+1)*200-32},a.beginChatting=function(){Input.releaseKeys(),console.log("beginning chat"),t=!0;var b=$("#viewport").offset(),c=$("<form id='chatform' style='display:none;'><input type='text' placeholder='type your message' autocomplete='off' /></form>").css({left:f.getLeft()+b.left-100,top:f.getTop()+b.top-50});$("body").append(c),$("input",c).blur(function(){a.endChatting()}),c.submit(function(b){b.preventDefault();var d=$.trim($("input",c).val());d.length&&(console.log("chatting: "+d),socket.emit("game:player:chat",d),a.endChatting())}),c.show(),$("input",c).focus()},a.endChatting=function(){Input.bindKeys(),t=!1,$("#chatform").fadeOut("fast",function(){$(this).remove()})},a.isChatting=function(){return t},a.showChatMessage=function(a){var b=$("#viewport").offset(),c=g.getId()==a.id?g:f,d=$("<div class='chatbubble' style='display:none;'>"+a.msg+"</div>");d.addClass(c.getSide()),$("body").append(d),d.css("top",c.getTop()+b.top-40-d.height()/2),c.getSide()=="left"?d.css("left",b.left+8):d.css("left",b.left+$("#viewport").width()-d.width()-21),d.fadeIn("normal",function(){setTimeout(function(){d.fadeOut("normal",function(){d.remove()})},3500)}),c.getId()==g.getId()&&SoundManager.playSound("chat")},a.start=function(a){s=!1,q=!1,r=!1,t=!1,p=!1,o=-1,n=a,c=(new Date).getTime(),k=[],l=[],h=[],i=[],j=[]},a.handleWin=function(b){SoundManager.playSound("game:win");var c=b.scores.win==1?"point":"points",d="<h2>Congratulations - you win!</h2><p>Well done - you beat "+g.getUsername()+" by <strong>"+b.scores.win+"</strong> "+c+" to <strong>"+b.scores.lose+"</strong>.</p>"+"<h3>Ranking change</h3>"+"<p>Your rank has increased to <strong>"+b.rank+"</strong> (+"+b.increase+")</p>"+"<h3>Tweet all about it</h3>"+"<p>Why not let the world know about your victory? Tweet and find some new people to beat!</p>"+tweetButton({text:"I just won a game of Sock it to 'em - why not come and challenge me to a duel?",count:"none"});a.endGame(d)},a.handleLose=function(b){SoundManager.playSound("game:lose");var c=b.scores.win==1?"point":"points",d="<h2>Oh no - you lose!</h2><p>Bad luck - you lost to "+g.getUsername()+" by <strong>"+b.scores.win+"</strong> "+c+" to <strong>"+b.scores.lose+"</strong>.</p>"+"<h3>Ranking change</h3>";b.decrease?d+="<p>Your rank has decreased to <strong>"+b.rank+"</strong> (-"+b.decrease+")</p>":d+="<p>Your rank has remained unchanged at <strong>"+b.rank+"</strong></p>",d+="<h3>Spread the word</h3><p>Why not challenge someone else? Spread the word to find some new people to beat!</p>"+tweetButton({text:"Fancy a duel? Come and have a game of Sock it to em'!",count:"none"}),a.endGame(d)},a.cancelGame=function(b){var c="<h2>Game aborted!</h2><p>Oh no - "+g.getUsername()+" left the game! ";b.defaulted?c+="As it was underway, they have <strong>defaulted</strong> against you. You don't get the glory of a win, but your rank has increased by <strong>one</strong> point, and theirs has decreased due to bailing out of your duel.</p>":c+="As it hadn't got properly underway it has been <strong>cancelled</strong>.</p>",a.endGame(c)},a.endGame=function(a,b){cancelRequestAnimFrame(animFrame),q=!0,Input.releaseKeys(),$("#countdown").html("Game Over"),mbalert(a,function(){socket.emit("game:finish")})},a.setSuddenDeath=function(){r=!0,SoundManager.playSound("game:suddendeath"),$("#countdown").html("Sudden Death")},a.bindKeys=function(){Input.captureKeys(["SPACE_BAR","UP_ARROW","DOWN_ARROW","LEFT_ARROW","RIGHT_ARROW"]),Input.bindTo(window),Input.bindKeys(),Input.onKeyPress("T",function(b){a.isChatting()||a.beginChatting()}),Input.onKeyPress("ESC",function(b){a.isChatting()&&a.endChatting()})},a.addPlatforms=function(){m[0]=new Platform,m[0].setCoordinates(0,this.getBottom()/3*1,48,10),m[1]=new Platform,m[1].setCoordinates(0,this.getBottom()/3*2,48,10),m[2]=new Platform,m[2].setCoordinates(this.getRight()-48,this.getBottom()/3*1,48,10),m[3]=new Platform,m[3].setCoordinates(this.getRight()-48,this.getBottom()/3*2,48,10)},a.changePlayerWeapon=function(a){SoundManager.playSound("weapon:change"),f.changeWeapon(a)},a}(),animFrame=null;Surface=function(a){var b,c;b=document.getElementById(a);if(!b.getContext)throw new Error("Canvas not available");c=b.getContext("2d"),b.width=c.canvas.clientWidth,b.height=c.canvas.clientHeight,this.line=function(a,b,d,e,f){c.strokeStyle=f,c.beginPath(),c.moveTo(a,b),c.lineTo(d,e),c.closePath(),c.stroke()},this.fillRect=function(a,b,d,e,f){c.fillStyle=f,c.fillRect(a,b,d,e)},this.getWidth=function(){return c.canvas.clientWidth},this.getHeight=function(){return c.canvas.clientHeight},this.pixel=function(a,b,d){c.fillStyle=d,this.fillRect(a,b,1,1)},this.square=function(a,b,d,e){c.fillStyle=e,this.fillRect(a,b,d,d)},this.drawImage=function(a,b,d,e,f){c.drawImage(a,b,d,e,f)},this.clear=function(){c.clearRect(0,0,b.width,b.height)},this.clearRect=function(a,b,d,e){c.clearRect(a,b,d,e)},this.circle=function(a,b,d,e){c.fillStyle=e,c.beginPath(),c.arc(a+d,b+d,d,0,Math.PI*2,!0),c.closePath(),c.fill()},this.fillText=function(a,b,d,e,f){c.fillStyle=e,f.font&&(c.font=f.font),f.textBaseline&&(c.textBaseline=f.textBaseline),f.textAlign&&(c.textAlign=f.textAlign),c.fillText(d,a,b)}};var Input={keyMap:{27:"ESC",32:"SPACE_BAR",37:"LEFT_ARROW",38:"UP_ARROW",39:"RIGHT_ARROW",40:"DOWN_ARROW",84:"T"},keysPressed:{},capturedKeys:{},target:null,triggers:{},keyDown:function(a){Input.keysPressed[a]=!0},keyUp:function(a){Input.keysPressed[a]=!1},isKeyDown:function(a){return Input.keysPressed[a]==1},captureKeys:function(a){for(var b=0;b<a.length;b++)Input.capturedKeys[a[b]]=!0},isCapturedKey:function(a){return Input.capturedKeys[a]==1},mapKey:function(a){return typeof Input.keyMap[a]!="undefined"?Input.keyMap[a]:"KEY_NOT_MAPPED"},releaseKeys:function(){$(Input.target).unbind("keydown"),$(Input.target).unbind("keyup")},bindKeys:function(){$(Input.target).keydown(function(a){var b=Input.mapKey(a.which);Input.isCapturedKey(b)&&a.preventDefault(),Input.keyDown(b)}),$(Input.target).keyup(function(a){var b=Input.mapKey(a.which);Input.isCapturedKey(b)?a.preventDefault():Input.triggers[b]!=null&&Input.triggers[b](a),Input.keyUp(b)})},bindTo:function(a){Input.target=a},onKeyPress:function(a,b){Input.triggers[a]=b}};Weapon=function(){var a=!0,b=(new Date).getTime(),c=0;this.isLoaded=function(){if(a)return!0;if(b==0)return!1;var c=(new Date).getTime();return a=c>=b,a},this.fire=function(d){d.type=c,GameManager.fireWeapon(d),a=!1,b=!1},this.reloadIn=function(a){b=(new Date).getTime()+a},this.setType=function(a){c=a}},Weapon.factory=function(a){var b=new Weapon;return b.setType(a),b};Player=function(a){this._id=a.id,this._x=a.x,this._y=a.y,this._a=a.a,this._v=a.v,this._c=a.c,this._username=a.username,this._side=a.side,this._cWeapon=0,this._weapons={0:Weapon.factory(0),1:Weapon.factory(1)},this.aim={x:0,y:0},this.oldAim={x:0,y:0},this.oldX=this._x,this.oldY=this._y,this.tick=function(){},this.getId=function(){return this._id},this.preRender=function(){var a=GameManager.getSurface();a.clearRect(this.aim.x|0,this.aim.y|0,5,5),a.clearRect(this._x|0,this._y|0,16,32)},this.render=function(){GameManager.getSurface().fillRect(this._x|0,this._y|0,16,32,this._c)},this.renderSight=function(){var a=GameManager.getSurface();this.aim.x=this._x+Math.cos(this._a/180*Math.PI)*this._v|0,this.aim.y=this._y+Math.sin(this._a/180*Math.PI)*this._v|0,GameManager.getSurface().square(this.aim.x,this.aim.y,5,"rgb(0, 0, 0)")},this.fireWeapon=function(){if(!this.getWeapon().isLoaded())return;var a={a:this._a,v:this._v};this.getWeapon().fire(a)},this.setReloadTime=function(a){this.getWeapon().reloadIn(a)},this.changeWeapon=function(a){console.log("changing to weapon "+a),this._cWeapon=a},this.getWeapon=function(){return this._weapons[this._cWeapon]},this.getUsername=function(){return this._username},this.decreaseAngle=function(){this._a--},this.increaseAngle=function(){this._a++},this.decreaseVelocity=function(){this._v>25&&this._v--},this.increaseVelocity=function(){this._v<200&&this._v++},this.getLeft=function(){return this._x},this.getTop=function(){return this._y},this.getRight=function(){return this.getLeft()+16},this.getBottom=function(){return this.getTop()+32},this.spawn=function(a){this._x=a.x,this._y=a.y},this.getSide=function(){return this._side}},Player.factory=function(a){return console.log("Player::factory",a),new Player(a)};this.mbalert=function(a,b){var c=$(["<div class='modal hide fade'>","<div class='modal-body'>",a,"</div>","<div class='modal-footer'>","<a class='btn primary' href='#'>OK</a>","</div>","</div>"].join("\n"));$("body").append(c),c.bind("hidden",function(){c.remove()}),c.bind("shown",function(){$("a.primary",c).focus()}),c.bind("hide",function(){typeof b=="function"&&b()}),$("a",c).click(function(a){a.preventDefault(),c.modal("hide")}),c.modal({backdrop:"static",keyboard:!0,show:!0})},this.mbconfirm=function(a,b,c,d){c==null&&(c="OK"),d==null&&(d="Cancel");var e=!1,f=$(["<div class='modal hide fade'>","<div class='modal-body'>",a,"</div>","<div class='modal-footer'>","<a class='btn primary' href='#'>"+c+"</a>","<a class='btn danger' href='#'>"+d+"</a>","</div>","</div>"].join("\n"));$("body").append(f),f.bind("hidden",function(){f.remove()}),f.bind("hide",function(){!e&&typeof b=="function"&&b(!1)}),f.bind("shown",function(){$("a.primary",f).focus()}),$("a",f).click(function(a){e=!0;var c=$(this).hasClass("primary");a.preventDefault(),f.modal("hide"),typeof b=="function"&&b(c)}),f.modal({backdrop:"static",show:!0})},this.mbmodal=function(a,b,c){var d="";for(var e in b){var f=b[e];d+="<a data-handler='"+e+"' class='btn "+f.class+"' href='#'>"+e+"</a>"}var g=$(["<div class='modal hide fade'>","<div class='modal-body'>",a,"</div>","<div class='modal-footer'>",d,"</div>","</div>"].join("\n"));g.bind("hidden",function(){g.remove()}),g.bind("hide",function(){}),g.bind("shown",function(){$("a.primary",g).focus()}),$("a",g).click(function(a){a.preventDefault(),g.modal("hide");var c=$(this).data("handler"),d=b[c].callback;typeof d=="function"&&d()}),g.modal({backdrop:"static",show:!0}),$("body").append(g)},loadScript("/js/deps/bootstrap-modal.1.3.0.js");